services:
  butantan-shield:
    build:
      context: ..
      dockerfile: apps/butantan-shield/Dockerfile
    environment:
      NODE_ENV: production
      SHIELD_PORT: "4001"
      SHIELD_TOKEN: ${SHIELD_TOKEN:-local-dev-token}
    ports:
      - "4001:4001"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4001/readiness').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 15
    stop_grace_period: 20s
    restart: unless-stopped

  chronos-backoffice:
    build:
      context: ..
      dockerfile: apps/chronos-backoffice/Dockerfile
    environment:
      NODE_ENV: production
      CHRONOS_MODE: shield
      SHIELD_URL: "http://butantan-shield:4001"
      SHIELD_TOKEN: ${SHIELD_TOKEN:-local-dev-token}
      PORT: "3000"
    ports:
      - "3000:3000"
    depends_on:
      butantan-shield:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/readiness').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 30
    stop_grace_period: 20s
    restart: unless-stopped

  conductor-service:
    build:
      context: ..
      dockerfile: apps/aurora-conductor-service/Dockerfile
    environment:
      NODE_ENV: production
      CONDUCTOR_PORT: "4101"
      CONDUCTOR_TOKEN: ${CONDUCTOR_TOKEN:-local-dev-conductor-token}
      CONDUCTOR_ARTIFACT_DIR: "/data/artifacts"
    volumes:
      - conductor_artifacts:/data/artifacts
    ports:
      - "4101:4101"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4101/readiness').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 10s
      timeout: 3s
      retries: 15
    stop_grace_period: 20s
    restart: unless-stopped

volumes:
  conductor_artifacts:
